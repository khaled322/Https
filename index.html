<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ููุตุฉ ุชุชุจุน ุงูุทูุจูุงุช โ ุฅุฏุงุฑุฉ ูุชูุฏูุฉ</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; }
    .sidebar-backdrop { background: rgba(0,0,0,0.45); }
    .table-wrap { overflow-x:auto; }
    /* toast */
    .toast {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 24px; z-index: 60;
      background: rgba(20,20,20,0.95); color: #fff; padding: 10px 14px; border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

  <div class="flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 right-0 w-64 bg-white border-l shadow-lg transform translate-x-0 transition-transform duration-200 z-40">
      <div class="p-4 flex items-center justify-between border-b">
        <div class="text-lg font-bold">ุงููุงุฆูุฉ</div>
        <button id="closeSidebar" class="md:hidden text-gray-600">โ</button>
      </div>
      <nav class="p-4 space-y-2">
        <button data-page="home" class="w-full text-right px-3 py-2 rounded hover:bg-slate-100 navBtn">๐ ุงูุฑุฆูุณูุฉ</button>
        <button data-page="new" class="w-full text-right px-3 py-2 rounded hover:bg-slate-100 navBtn">โ ุฅุถุงูุฉ ุฅุญุตุงุก ููุชุฌ</button>
        <button data-page="products" class="w-full text-right px-3 py-2 rounded hover:bg-slate-100 navBtn">๐งพ ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</button>
        <button data-page="history" class="w-full text-right px-3 py-2 rounded hover:bg-slate-100 navBtn">๐ฆ ุณุฌู ุงูุฃูุงู</button>
        <button data-page="stats" class="w-full text-right px-3 py-2 rounded hover:bg-slate-100 navBtn">๐ ุงูุฅุญุตุงุกุงุช</button>
        <hr class="my-2" />
        <div>
          <div class="text-sm text-gray-500 mb-1">ุงูุฅุนุฏุงุฏุงุช ุงูุณุฑูุนุฉ</div>
          <button id="exportBtn" class="w-full text-right px-3 py-2 rounded hover:bg-slate-100">โฌ๏ธ ุชุตุฏูุฑ CSV</button>
        </div>
      </nav>
    </aside>

    <!-- Mobile backdrop -->
    <div id="backdrop" class="hidden fixed inset-0 z-30 md:hidden"></div>

    <!-- Main content -->
    <div class="flex-1 min-h-screen md:mr-64">
      <header class="flex items-center justify-between p-4 border-b bg-white">
        <div class="flex items-center gap-3">
          <button id="openSidebar" class="md:hidden p-2 bg-slate-100 rounded">โฐ</button>
          <h1 class="text-xl font-bold">ููุตุฉ ุชุชุจุน ุงูุทูุจูุงุช โ ุฅุฏุงุฑุฉ</h1>
        </div>
        <div class="text-sm text-gray-600">Responsive โข ุขูู ููุนุฑุถ ุงููุญูู</div>
      </header>

      <main class="p-4 max-w-6xl mx-auto">

        <!-- HOME: summary + per-product cards -->
        <section id="pageHome" class="">
          <div class="grid md:grid-cols-3 gap-4">
            <div class="col-span-2 bg-white p-4 rounded shadow">
              <h2 class="text-lg font-semibold mb-2">ููุฎุต ุณุฑูุน ููู ุงูููุชุฌุงุช</h2>
              <div id="homeProducts" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
            </div>
            <div class="bg-white p-4 rounded shadow">
              <h3 class="font-semibold mb-2">ุฅุฌูุงูู ุณุฑูุน</h3>
              <div class="space-y-2">
                <div class="p-3 bg-indigo-50 rounded text-center"><div class="text-sm text-gray-600">ุฅุฌูุงูู ุงูุทูุจูุงุช ุงูููู</div><div id="homeTotalToday" class="text-2xl font-bold">0</div></div>
                <div class="p-3 bg-emerald-50 rounded text-center"><div class="text-sm text-gray-600">ูุณุจุฉ ุงููุคูุฏุฉ (ุงููููู)</div><div id="homeConfirmedPct" class="text-2xl font-bold">0%</div></div>
                <div class="p-3 bg-yellow-50 rounded text-center"><div class="text-sm text-gray-600">ูุณุจุฉ ูููุฑู (ุดูุฑู)</div><div id="homeDeliveredPct" class="text-2xl font-bold">0%</div></div>
              </div>
            </div>
          </div>
        </section>

        <!-- NEW: choose product then fill stats -->
        <section id="pageNew" class="hidden mt-6">
          <div class="bg-white p-4 rounded shadow">
            <h2 class="text-lg font-semibold mb-3">ุฅุถุงูุฉ ุฅุญุตุงุก ููุชุฌ ูููู</h2>

            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block mb-1 font-medium">ุงุฎุชุฑ ุงูููุชุฌ</label>
                <select id="selectProduct" class="w-full border rounded px-3 py-2 mb-3">
                  <option value="">-- ุงุฎุชุฑ ููุชุฌ --</option>
                </select>

                <div id="singleProductForm" class="space-y-3">
                  <div>
                    <label class="block text-sm">ุนุฏุฏ ุงูุทูุจูุงุช (count)</label>
                    <input id="inp_count" type="number" min="0" class="w-full px-3 py-2 border rounded" />
                  </div>
                  <div>
                    <label class="block text-sm">ูุตูุช ุงูููู (ูููุฑู) โ ูุณุชูู</label>
                    <input id="inp_delivered" type="number" min="0" class="w-full px-3 py-2 border rounded" />
                  </div>
                </div>

                <div class="mt-3">
                  <label class="block text-sm">ููุงุญุธุงุช (ุงุฎุชูุงุฑู)</label>
                  <textarea id="inp_note" rows="3" class="w-full px-3 py-2 border rounded"></textarea>
                </div>

                <div class="mt-4 flex gap-2 items-center">
                  <button id="btnMarkComplete" class="px-4 py-2 bg-sky-600 text-white rounded">ูุถุน ูู ููุชูู ููุฐุง ุงูููุชุฌ ุงูููู</button>
                  <button id="btnClearSingle" class="px-4 py-2 bg-gray-200 rounded">ุฅุนุงุฏุฉ</button>
                </div>

                <p id="singleMsg" class="text-sm text-green-600 mt-2"></p>
              </div>

              <div>
                <label class="block mb-1 font-medium">ุงูุญูุธ ุงูุนุงู ููููู</label>
                <div class="mb-2">
                  <label class="block text-sm">ุนุฏุฏ ุงูุทูุจูุงุช ุงููุคูุฏุฉ ุงูููู (ูุฌููุน)</label>
                  <input id="global_confirmed" type="number" min="0" class="w-full px-3 py-2 border rounded" />
                </div>
                <div class="mb-2">
                  <label class="block text-sm">ุนุฏุฏ ุงูุทูุจูุงุช ุงูููุบุงุฉ ุงูููู (ูุฌููุน)</label>
                  <input id="global_canceled" type="number" min="0" class="w-full px-3 py-2 border rounded" />
                </div>
                <div class="mb-2">
                  <label class="block text-sm">ุฃุณุจุงุจ ุงูุฅูุบุงุก (ุณุทุฑ ููู ุณุจุจ)</label>
                  <textarea id="global_reasons" rows="3" class="w-full px-3 py-2 border rounded"></textarea>
                </div>

                <!-- Confirmation step BEFORE saving -->
                <div class="mt-3 p-3 border rounded bg-gray-50">
                  <div class="flex items-center gap-2">
                    <input id="confirmCheck" type="checkbox" class="w-4 h-4" />
                    <label for="confirmCheck" class="text-sm">ุฃูุง ูุชุฃูุฏุฉ โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก ูู ูุฐู ุงูุจูุงูุงุช</label>
                  </div>
                  <div class="mt-3 flex gap-2">
                    <button id="btnSaveAll" class="px-4 py-2 bg-green-600 text-white rounded" disabled>ุญูุธ ุฌููุน ุจูุงูุงุช ุงูููู</button>
                    <button id="btnCancelSave" class="px-4 py-2 bg-gray-200 rounded">ุฅูุบุงุก</button>
                  </div>
                  <p id="saveAllMsg" class="text-sm text-green-600 mt-2"></p>
                </div>

              </div>
            </div>
          </div>
        </section>

        <!-- PRODUCTS management -->
        <section id="pageProducts" class="hidden mt-6">
          <div class="bg-white p-4 rounded shadow">
            <h2 class="text-lg font-semibold mb-3">ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</h2>

            <div class="flex gap-2 mb-4">
              <input id="prodName" class="flex-1 px-3 py-2 border rounded" placeholder="ุงุณู ุงูููุชุฌ ุฌุฏูุฏ" />
              <button id="btnAddProd" class="px-4 py-2 bg-blue-600 text-white rounded">ุฅุถุงูุฉ</button>
            </div>

            <div id="productsTable" class="table-wrap"></div>
          </div>
        </section>

        <!-- HISTORY: daily records -->
        <section id="pageHistory" class="hidden mt-6">
          <div class="bg-white p-4 rounded shadow">
            <h2 class="text-lg font-semibold mb-3">ุณุฌู ุงูุฃูุงู</h2>
            <div class="flex flex-col md:flex-row gap-2 md:items-center mb-4">
              <input id="historyDate" type="date" class="px-3 py-2 border rounded" />
              <button id="btnShowHistory" class="px-4 py-2 bg-blue-600 text-white rounded">ุนุฑุถ</button>
              <div class="text-sm text-gray-500">ุนุฑุถ ุณุฌูุงุช ุงูููุชุฌ ุงููุญุฏุฏ ููู ููู.</div>
            </div>

            <div id="historyResult" class="table-wrap"></div>
          </div>
        </section>

        <!-- STATS: monthly delivered percentage and others -->
        <section id="pageStats" class="hidden mt-6">
          <div class="bg-white p-4 rounded shadow">
            <h2 class="text-lg font-semibold mb-3">ุงูุฅุญุตุงุกุงุช</h2>

            <div class="flex flex-col md:flex-row gap-2 items-center mb-4">
              <label class="text-sm">ุงุฎุชุฑ ุงููุทุงู:</label>
              <select id="statsSelector" class="px-3 py-2 border rounded">
                <option value="thisMonth">ูุฐุง ุงูุดูุฑ</option>
                <option value="lastMonth">ุงูุดูุฑ ุงููุงุถู</option>
                <option value="custom">ูุทุงู ุดูุฑู ูุฎุตุต</option>
                <option value="all">ูู ุงูุจูุงูุงุช</option>
              </select>

              <input id="statFrom" type="month" class="px-3 py-2 border rounded hidden" />
              <input id="statTo" type="month" class="px-3 py-2 border rounded hidden" />

              <button id="btnComputeStats" class="px-4 py-2 bg-indigo-600 text-white rounded">ุญุณุงุจ</button>
            </div>

            <div class="grid md:grid-cols-3 gap-3 mb-4">
              <div class="p-3 bg-indigo-50 rounded text-center"><div class="text-sm text-gray-600">ุฅุฌูุงูู ุงูุทูุจูุงุช (ุงููุทุงู)</div><div id="statTotal" class="text-2xl font-bold">0</div></div>
              <div class="p-3 bg-emerald-50 rounded text-center"><div class="text-sm text-gray-600">ูุณุจุฉ ุงููุคูุฏุฉ</div><div id="statConfirmedPct" class="text-2xl font-bold">0%</div></div>
              <div class="p-3 bg-yellow-50 rounded text-center"><div class="text-sm text-gray-600">ูุณุจุฉ ูููุฑู (ุดูุฑู)</div><div id="statDeliveredPct" class="text-2xl font-bold">0%</div></div>
            </div>

            <div class="grid md:grid-cols-2 gap-4 mb-4">
              <div class="p-3 bg-white rounded shadow">
                <h4 class="font-medium mb-2">ุชูุฒูุน ุงูุญุงูุฉ</h4>
                <canvas id="chartPie"></canvas>
              </div>
              <div class="p-3 bg-white rounded shadow">
                <h4 class="font-medium mb-2">ูุฌููุน ุงูุทูุจูุงุช ูููููุง</h4>
                <canvas id="chartLine"></canvas>
              </div>
            </div>

            <div class="p-3 bg-white rounded shadow mb-4">
              <h4 class="font-medium mb-2">ูุณุจุฉ ูููุฑู ุญุณุจ ูู ุดูุฑ (ุฑุณู)</h4>
              <canvas id="chartMonthlyDelivered"></canvas>
            </div>

            <div class="p-3 bg-white rounded shadow">
              <h4 class="font-medium mb-2">ุชูุงุตูู ุดูุฑูุฉ ููู ููุชุฌ</h4>
              <div id="productMonthlyList" class="space-y-3"></div>
            </div>

          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- toast container -->
  <div id="toastWrap" style="pointer-events:none;"></div>

  <!-- Firebase + logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      where,
      getDocs,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // ======= Firebase config (ูุถููู ููุง ุทูุจุช) =======
    const firebaseConfig = {
      apiKey: "AIzaSyD2ddRXrr2phXa54q37nq28F5xFDC7pa6E",
      authDomain: "orders-tracker-8265e.firebaseapp.com",
      projectId: "orders-tracker-8265e",
      storageBucket: "orders-tracker-8265e.appspot.com",
      messagingSenderId: "901944393997",
      appId: "1:901944393997:web:b0e5fc7941710fe9c6b044"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // helpers
    const $ = id => document.getElementById(id);
    const todayIso = () => new Date().toISOString().slice(0,10);
    const nowMonth = () => new Date().toISOString().slice(0,7);

    // local products store
    let products = JSON.parse(localStorage.getItem('ot_products') || '[]');

    // Sidebar toggle mobile
    const sidebar = $('sidebar');
    const openSidebar = $('openSidebar');
    const closeSidebar = $('closeSidebar');
    const backdrop = $('backdrop');
    openSidebar.onclick = () => { sidebar.style.transform='translateX(0)'; backdrop.classList.remove('hidden'); backdrop.classList.add('sidebar-backdrop'); };
    closeSidebar.onclick = () => { sidebar.style.transform='translateX(100%)'; backdrop.classList.add('hidden'); };
    backdrop.onclick = closeSidebar;
    if (window.innerWidth < 768) sidebar.style.transform='translateX(100%)';

    // nav
    document.querySelectorAll('.navBtn').forEach(btn => btn.onclick = (e) => { showPage(e.currentTarget.dataset.page); });

    function showPage(page) {
      ['pageHome','pageNew','pageProducts','pageHistory','pageStats'].forEach(id => $(id).classList.add('hidden'));
      if (page === 'home') $('pageHome').classList.remove('hidden');
      if (page === 'new') $('pageNew').classList.remove('hidden');
      if (page === 'products') $('pageProducts').classList.remove('hidden');
      if (page === 'history') $('pageHistory').classList.remove('hidden');
      if (page === 'stats') $('pageStats').classList.remove('hidden');
      // close mobile sidebar
      if (window.innerWidth < 768) { sidebar.style.transform='translateX(100%)'; backdrop.classList.add('hidden'); }
      // refresh homepage when opened
      if (page === 'home') loadHomeSummary();
    }

    // initial page
    showPage('home');

    // utility: toast
    function showToast(msg, time=2500) {
      const wrap = $('toastWrap');
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      wrap.appendChild(t);
      setTimeout(()=> { t.remove(); }, time);
    }

    // ---------- Products management ----------
    function renderProductsTable() {
      const cont = $('productsTable');
      if (!products.length) {
        cont.innerHTML = `<div class="p-3 text-gray-500">ูุง ุชูุฌุฏ ููุชุฌุงุช โ ุฃุถู ููุชุฌูุง ุฌุฏูุฏูุง.</div>`;
        populateProductSelect();
        return;
      }
      let html = `<div class="overflow-x-auto"><table class="w-full text-right border"><thead class="bg-gray-100"><tr><th class="p-2">ุงูููุชุฌ</th><th class="p-2">ุงูุนูููุงุช</th></tr></thead><tbody>`;
      products.forEach(p => {
        html += `<tr class="border-t"><td class="p-2">${p}</td><td class="p-2"><button class="px-3 py-1 bg-red-100 text-red-600 rounded btnDel" data-prod="${p}">ุญุฐู</button></td></tr>`;
      });
      html += `</tbody></table></div>`;
      cont.innerHTML = html;
      document.querySelectorAll('.btnDel').forEach(b => b.onclick = (e) => {
        const name = e.currentTarget.dataset.prod;
        if (!confirm('ูู ุชุฑูุฏ ุญุฐู ุงูููุชุฌ: ' + name + ' ุ ุณุชููุฏ ุฃู ุฅุฏุฎุงูุงุช ูุณุชูุจููุฉ ูุฎุตุตุฉ ูู.')) return;
        products = products.filter(x => x !== name);
        localStorage.setItem('ot_products', JSON.stringify(products));
        renderProductsTable();
        renderProductsSelectOptions();
        showToast('ุชู ุญุฐู ุงูููุชุฌ');
      });
      populateProductSelect();
    }

    $('btnAddProd').onclick = () => {
      const v = $('prodName').value.trim();
      if (!v) return alert('ุฃุฏุฎู ุงุณู ุงูููุชุฌ');
      if (products.includes(v)) return alert('ุงูููุชุฌ ููุฌูุฏ ุจุงููุนู');
      products.push(v);
      localStorage.setItem('ot_products', JSON.stringify(products));
      $('prodName').value = '';
      renderProductsTable();
      showToast('ุชู ุฅุถุงูุฉ ุงูููุชุฌ');
    };

    function populateProductSelect() {
      const sel = $('selectProduct');
      sel.innerHTML = `<option value="">-- ุงุฎุชุฑ ููุชุฌ --</option>`;
      products.forEach(p => {
        const opt = document.createElement('option'); opt.value = p; opt.textContent = p;
        sel.appendChild(opt);
      });
    }

    renderProductsTable();

    // ---------- Single product entry (in New) ----------
    $('btnMarkComplete').onclick = () => {
      const prod = $('selectProduct').value;
      if (!prod) return alert('ุงุฎุชุฑ ููุชุฌูุง ุฃููุงู');
      const cnt = parseInt($('inp_count').value || 0);
      const del = parseInt($('inp_delivered').value || 0);
      // If both are zero, warn
      if (cnt === 0 && del === 0) return alert('ุฃุฏุฎู ูููุฉ ููุนุฏุฏ ุฃู ูููุตูู (ูููุฑู)');
      // Show temporary message that this product marked complete for today (but not yet saved to Firestore until full save)
      $('singleMsg').textContent = `ุชู ุชุณุฌูู ุฅุญุตุงุก ${prod} ููุฐุง ุงูููู (ูู ูุชู ุงูุญูุธ ุงูููุงุฆู ุจุนุฏ).`;
      // Save to a temporary local store (session) to be included on final save OR allow immediate saving of single product?
      // We'll store temporary entries in sessionStorage 'ot_pending' as array
      const pending = JSON.parse(sessionStorage.getItem('ot_pending') || '[]');
      // ensure each product/day only one pending โ overwrite if exists
      const date = todayIso();
      const filtered = pending.filter(x => !(x.product === prod && x.date === date));
      filtered.push({
        date,
        month: date.slice(0,7),
        product: prod,
        count: cnt,
        delivered: del,
        note: $('inp_note').value.trim(),
        timestamp: new Date().toISOString()
      });
      sessionStorage.setItem('ot_pending', JSON.stringify(filtered));
      showToast('ุชู ูุถุน ุงูุฅุญุตุงุก ูุคูุชูุง. ุงุถุบุทู \"ุฃูุง ูุชุฃูุฏุฉ\" ุซู \"ุญูุธ ุฌููุน ุจูุงูุงุช ุงูููู\" ููุญูุธ ูู ุงูุณุญุงุจุฉ.');
      // optionally clear inputs for further entries
      $('inp_count').value = ''; $('inp_delivered').value = ''; $('inp_note').value = '';
      // update homepage preview quickly (local)
      loadHomeSummary(); // will include pending as well
    };

    // Confirmation checkbox enabling save
    $('confirmCheck').onchange = (e) => {
      $('btnSaveAll').disabled = !e.target.checked;
    };

    // Save all pending entries + global confirmed/canceled into Firestore
    $('btnSaveAll').onclick = async () => {
      const pending = JSON.parse(sessionStorage.getItem('ot_pending') || '[]');
      if (pending.length === 0) return alert('ูุง ุชูุฌุฏ ุฅุฏุฎุงูุงุช ูุคูุชุฉ ููุญูุธ. ุฃุถู ุจูุงูุงุช ุงูููุชุฌุงุช ุฃูููุง.');
      const confirmed = parseInt($('global_confirmed').value || 0);
      const canceled = parseInt($('global_canceled').value || 0);
      const reasons = $('global_reasons').value.trim().split('\n').filter(r=>r);
      // Build docs: for each pending product, add confirmed/canceled values as global fields (they are same for each doc as per earlier design)
      const docs = pending.map(p => ({
        date: p.date,
        month: p.month,
        product: p.product,
        count: parseInt(p.count || 0),
        delivered: parseInt(p.delivered || 0),
        type: 'ุฌุฏูุฏุฉ',
        confirmed,
        canceled,
        reasons,
        note: p.note || '',
        timestamp: p.timestamp
      }));
      try {
        $('saveAllMsg').textContent = 'ุฌุงุฑู ุญูุธ ุงูุจูุงูุงุช...';
        await Promise.all(docs.map(d => addDoc(collection(db,'orders'), d)));
        sessionStorage.removeItem('ot_pending');
        $('saveAllMsg').textContent = 'ุชู ุงูุญูุธ ูู ุงูุณุญุงุจุฉ โ';
        $('global_confirmed').value=''; $('global_canceled').value=''; $('global_reasons').value='';
        $('confirmCheck').checked = false; $('btnSaveAll').disabled = true;
        showToast('ุชู ุญูุธ ุจูุงูุงุช ุงูููู ุจูุฌุงุญ');
        l
